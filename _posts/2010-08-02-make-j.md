---
layout: default
title: make -j 的并行任务个数选择
---

在多CPU上编译Linux内核时可以用 make -jn 多个任务并行编译加快速度。
印象中在某个文档看到过 n 选择为 ncpu + 1，但不清楚理论依据何在。
查了一下也没看到这个说法的原始来源，因此在一个四核的CPU上做了一下
简单的测试，结论是在 n 等于 CPU 个数时的速度最快。下面是结果数据：

<pre>
n system   user    real
1 52.477 662.534 693.391
2 48.227 606.096 318.699
3 40.066 500.220 184.886
4 38.619 474.832 140.242
5 38.360 479.650 141.821
6 37.721 480.068 141.241
7 38.188 481.979 141.872
8 38.685 483.338 142.171
</pre>

用到的脚本如下（为降低其他因素的干扰，所有的文件及编译过程都放在内存之中进行）：

<pre>
 1 #!/bin/sh
 2
 3 tar -C /dev/shm -xjf linux-2.6.34.tar.bz2
 4
 5 mount -o remount,exec /dev/shm
 6
 7 pushd /dev/shm/linux-2.6.34
 8
 9 for i in `seq 1 8`; do
10     [ -d ../${i} ] &amp;&amp; rm -fr ../${i}/* || mkdir ../${i}
11     cp /boot/config ../${i}/.config
12     time make O=../${i} -j ${i} oldconfig &gt; /dev/null
13     time make O=../${i} -j ${i} &gt; /dev/null
14     rm -fr ../${i}
15 done
16
17 popd
18
19 mount -o remount,noexec /dev/shm
</pre>

{{ page.date | date_to_string }}
